var TEST=window.TEST||!1;(function(e){var t=$(e).find(".errorTip"),n=$.cookie("ctfo_bs_userName"),r="",i=$.cookie("ctfo_bs_corpCode"),s=$.cookie("ctfo_bs_rememberLoginFlag"),o=function(){$(e).find(".imgCode").attr("src","portal/rondamImage.action?d"+(new Date).getTime())},u=function(e){return $(e).each(function(e){var n=$(this).val(),r=$(this).attr("title");if(!n||n===r)return t.text(r),!1}),t.text(""),!0},a=function(e,t,n){e?($.cookie("ctfo_bs_userName",t,{path:"/",expires:30}),$.cookie("ctfo_bs_corpCode",n,{path:"/",expires:30}),$.cookie("ctfo_bs_rememberLoginFlag",e,{path:"/",expires:30})):($.cookie("ctfo_bs_rememberLoginFlag",null,{path:"/"}),$.cookie("ctfo_bs_userName",null,{path:"/"}),$.cookie("ctfo_bs_corpCode",null,{path:"/"}))},f=function(){if(!u($(e).find(".input")))return!1;$(e).loadMask(""),r=$(e).find("input[name=password]").val();var n=$(e).find("input[name=userStorage]").attr("checked"),i=$(e).find("input[name=userName]").val().toLowerCase(),s=hex_sha1(r).toLowerCase(),f=$(e).find("input[name=imgCode]").val(),c=$(e).find("input[name=corpCode]").val();a(n,i,c);var h={"requestParam.equal.opLoginname":i,"requestParam.equal.opPass":s,imgCode:f,"requestParam.equal.corpCode":c};$.ajax({url:"portal/login.action",type:"POST",dataType:"json",data:h,complete:function(t,n){$(e).unLoadMask()},success:function(n,r,i){if(n&&n.error)return o(),t.text(n.error[0].errorMessage),!1;if(n&&n.opEndutc&&n.opEndutc<(new Date).getTime())return o(),t.text("用户权限过期"),!1;if(!l())return CTFO.Model.passwordWindow.getInstance().popResetPasswordWin(),!1;$(e).remove(),window.location.replace("index.html")},error:function(e,n,r){o(),t.text("登录出错")}})},l=function(){var e=new RegExp("^[0-9]*$","g"),t=new RegExp("^[a-zA-Z]*$","g"),n=r.search(e),i=r.search(t);return n==0||i==0?!1:!0};document.onkeydown=function(t){var n=window.event||t,r=n.keyCode||n.which;+r===13&&$(e).find(".login_submit").trigger("click")},o(),$(e).find("input[name=userName]").val(n?n:"用户名").end().find("input[name=corpCode]").val(i?i:"组织编码").end().find("input").focus(function(e){var t=$(this).val(),n=$(this).attr("title");if(!t||t===n)$(this).attr("name")==="password"&&$(this).siblings("div:eq(0)").hide(),$(this).val("")}).blur(function(e){var n=$(this).val(),r=$(this).attr("title");if(!n||n===r)$(this).val(r),$(this).attr("name")==="password"&&($(this).siblings("div:eq(0)").show(),$(this).val("")),t.text("请输入"+r)}).end().find(".imgCode").click(function(e){o()}).end().find("input[name=userStorage]").attr("checked",s||!1).end().find(".login_submit").click(function(e){f()}).end().find(".saveFavorite").click(function(e){var t=window.location.href,n=document.title||"客车公共服务平台";document.all?window.external.AddFavorite(t,n):window.sidebar?window.sidebar.addPanel(n,t,""):alert("您的浏览器不支持自动加入收藏，请手动设置！")}),$(e).find("input[name=userName]").focus(),TEST&&$(e).find("input[name=userName]").val("hhadmin").end().find("input[name=corpCode]").val("601260").end().find("input[name=password]").val("888888").end().find("input[name=imgCode]").focus()})($("form[name=loginForm]")),$(function(){$(".login_content").prepend("<div class='downfile_box'></div>"),$(".down .small").click(function(){var e=$(this);$(".down .big").addClass("none"),e.hasClass("phone2")?$(".down .phone").removeClass("none"):$(".down .cs").removeClass("none"),setTimeout(function(){$(document.body).click(function(e){$(e.target).hasClass("small")||($(".down .big").addClass("none"),$(document.body).unbind("click"))})},10)})});